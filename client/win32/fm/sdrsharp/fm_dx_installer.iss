; Script generated by the Inno Script Studio Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!

[Messages]
UserInfoDesc=Please enter your user ID.  Name and organization can be anything (they are not used).
UserInfoSerial=&Numeric user ID

[Code]
function IsRDSLoggerInstalled: boolean;
begin
  result := DirExists('C:\SDRSharp\RDSDataLogger');
end;

function InitializeSetup(): Boolean;
var 
  ErrCode: integer;
begin
  result := IsRDSLoggerInstalled;
  if not result then
    if MsgBox('SDR Sharp plugin FM DX RDS Data Logger must be installed for this program to work.  The log directory C:\SDRSharp\RDSDataLogger was not found.  Create it or see the README file if you already have it installed elsewhere.  Would you like to install it now?', mbConfirmation, MB_YESNO) = IDYES
    then begin
      ShellExecAsOriginalUser('open', 'https://www.apritch.co.uk/sdrsharp_plugins.htm',
        '', '', SW_SHOW, ewNoWait, ErrCode);
    end;
  Result := True;
end;

function CheckSerial(Serial: String): Boolean;
begin
  Result := True;
end;

[Setup]
AppName=FM_DX_reporter
AppVersion=1.0
WizardStyle=modern
UserInfoPage=yes
DisableDirPage=no
DefaultDirName={sd}\FMDX
DefaultGroupName=FMDX
UninstallDisplayIcon={app}\fm_dx_reporter.exe
Compression=lzma2
SolidCompression=yes
OutputDir=C:\fmdx_src\installer
; "ArchitecturesAllowed=x64" specifies that Setup cannot run on
; anything but x64.
ArchitecturesAllowed=x64
; "ArchitecturesInstallIn64BitMode=x64" requests that the install be
; done in "64-bit mode" on x64, meaning it should use the native
; 64-bit Program Files directory and the 64-bit view of the registry.
ArchitecturesInstallIn64BitMode=x64
OutputBaseFilename=fmdx_install

[Files]
; fm_dx_reporter.exe was created with 'pp -o fm_dx_reporter.exe report_file.pl
Source: "C:\fmdx_src\fm_dx_reporter.exe"; DestDir: "{app}"; Flags: ignoreversion
Source: "C:\fmdx_src\README.TXT"; DestDir: "{app}"; Flags: isreadme
Source: "C:\fmdx_src\SDR_SHARP_README.TXT"; DestDir: "{app}";

[Run]
Filename: "schtasks"; \
    Parameters: "/Create /F /SC ONSTART /TN ""FMDX reporter"" /RU ""NT AUTHORITY\NETWORK SERVICE"" /TR ""'{app}\fm_dx_reporter.exe' -t {userinfoserial}"""; \
    Flags: runhidden; \
    StatusMsg: "Running schtasks to run fm_dx_reporter on start up"
; schtasks does not have certain switches so change it with powershell
Filename: "powershell"; \
    Parameters: "-command ""$t=Get-ScheduledTask 'FMDX reporter';$s=$t.Settings;$s.RestartInterval='PT5M';$s.RestartCount=9999;$s.ExecutionTimeLimit='PT0S';$s.DisallowStartIfOnBatteries=0;$s.StopIfGoingOnBatteries=0;Set-ScheduledTask $t;"; \
    Flags: runhidden; \
    StatusMsg: "Changing scheduled task execution time limit"
Filename: "schtasks"; \
    Parameters: "/Run /TN ""FMDX reporter"""; \
    Flags: runhidden; \
    StatusMsg: "Starting fm_dx_reporter.exe scheduled task"

[UninstallRun]
Filename: "schtasks"; \
    Parameters: "/End /TN ""FMDX reporter"""; \
    Flags: runhidden; \
    StatusMsg: "Stopping scheduled task FMDX reporter"
Filename: "schtasks"; \
    Parameters: "/Delete /F /TN ""FMDX reporter"""; \
    Flags: runhidden; \
    StatusMsg: "Running schtasks to stop running fm_dx_reporter.exe on start up"